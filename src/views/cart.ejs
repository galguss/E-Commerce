<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/main.css" rel="stylesheet" />
    <link href="css/shop.css" rel="stylesheet" />
    <title>Dynamic production line</title>
</head>
<body>
    <%- include('header') %>
    <main class="container">
        <h1>Products</h1>
        <section id="cart"></section>
        <h2 id="total">total: </h2>
        <% if(token){ %>
            <button value="<%= user._id %>" onclick="handleBay(this.value)" id="buy">buy</button>
        <% } %>
    </main>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="./js/LocalStorage.js"></script>
    <script>
        const cart = document.getElementById('cart');
        const Cart = new LocalStorage();
        let products = Cart.getCart();
        document.getElementById('total').innerHTML += calculationTotal();
        document.getElementById('cart-count').innerHTML = Cart.quantityCart();
        
        let cartBody = ``;

        products.map((product) =>{
          
        cartBody+=` <div class="product">
            <div class="image">
            <img src="${product.pathImage}" alt="product">
            </div>
            <span class="data"><span>${product.price}&#8362;</span><span>${product.description}</span></span>
            <span class="count">X${product.quantity}</span>
            <span class="actions"> 
            <button onclick="Cart.handleRemove('${product._id}')" class="delete">Delete</button class="delete">    
            </span>
            </div>`
         });

         function calculationTotal(){
            let total = 0;
            products.map(product => total += Number(product.price) * Number(product.quantity))
            return total;
         }

         function productsArray(){
            let array = [];
            products.map(product => array.push(product._id))
            return array;
         }

         function handleBay(userId){
            $.ajax({
                url: '/user/create-Order',
                method: 'POST',
                contentType: "application/json",
                data: JSON.stringify({
                userId,
                productList: productsArray(),
                total: calculationTotal()
              }),
                success: function(response) {
                    localStorage.removeItem("cart");
                    window.location.href = '/home';
                },
                error: function(error) {
                  $("#message_error").text(error?.responseJSON?.message);
                }
            });
      }

        cart.innerHTML = cartBody;
    </script>
</body>
</html>